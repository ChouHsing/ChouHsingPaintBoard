<!doctype html>
<html class="no-js">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1 user-scalable=no">
    <title>绘板</title>
    <link rel="stylesheet" href="https://cdn.luogu.com.cn/css/amazeui.min.css">
    <style>
        .main-body {
            padding-top: 51px;
            padding-bottom: 20px;
            color: #7f8c8d;
        }

        .about-color {
            color: #34495e;
        }

        .about-title {
            font-size: 180%;
            padding-top: 20px;
            text-align: center;
        }

        .paleitem {
            margin: 5px;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            background: #66ccff;
            display: inline-block;
            cursor: pointer;
        }

        #palette {
            padding: 10px;
            background: #7f7f7f;
            width: 500px;
            color: #fff;
        }

        .selected {
            border: #DAA520 3px solid;
        }

        #canvas-box {
            background: #6b6b6b;
            width: 800px;
            height: 400px;
            overflow: hidden;
            padding: 0;
            margin: 20px auto;
        }

        #mycanvas{
            position: relative;
            background: #000000;
            image-rendering: pixelated;
        }

        .description{
            margin-top: 10px;
        }
    </style>
</head>
<body>
<header class="am-topbar am-topbar-fixed-top">
    <div class="am-container">
        <h1 class="am-topbar-brand">
            <a href="#">周行算协冬日绘板</a>
        </h1>
        <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-secondary am-show-sm-only"
                data-am-collapse="{target: '#collapse-head'}"><span class="am-sr-only">导航切换</span> <span
                    class="am-icon-bars"></span></button>

        <div class="am-collapse am-topbar-collapse" id="collapse-head">
            <ul class="am-nav am-nav-pills am-topbar-nav">
            </ul>
        </div>
    </div>
</header>

<div class="am-g am-container main-body">
    <div class="am-u-lg-12">
        <div class="am-g">
            <div class="am-u-lg-11 am-u-lg-centered" id="canvas-box">
                <canvas width=800 height=400 id='mycanvas'>
            </div>
        </div>
    </div>
    <div class="am-g">
        <div class="am-u-lg-6">
            <div id='palette'>Loading...</div>
        </div>
        <div class="am-u-lg-2">
            <div class="am-vertical-align" style="height: 92.52px;text-align:center;">
                <div class="am-vertical-align-middle" id="custom-color-box">
                    <input type="color" id="custom-color" value="#ffffff">
                    <br>
                    <label for="custom-color">自定义颜色</label>
                </div>
            </div>
        </div>
        <div class="am-u-lg-4">
            <button type="button" class="am-btn am-btn-primary am-radius" zoom=1>全部显示</button>
            <button type="button" class="am-btn am-btn-secondary am-radius" zoom=5>放大5x</button>
            <button type="button" class="am-btn am-btn-success am-radius" zoom=10>放大10x</button>
        </div>
        <div class="am-u-lg-4">
            <p>
                还剩 <span id='timeleft' class="am-badge am-badge-secondary"></span>
            </p>
        </div>
    </div>
    <div class="description">
        <p>操作说明：左键绘制，右键拖动画板，滚轮缩放</p>
        <p>前端来源：<a href="https://www.luogu.com.cn">洛谷</a></p>
    </div>
</div>



<!--在这里编写你的代码-->

<!--[if (gte IE 9)|!(IE)]><!-->
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<!--<![endif]-->
<!--[if lte IE 8 ]>
<script src="https://libs.baidu.com/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
<script src="assets/js/amazeui.ie8polyfill.min.js"></script>
<![endif]-->
<script>
    let ctx = document.getElementById("mycanvas").getContext("2d");
    H = 400;
    W = 800;
    nowcolor = 0x000000;
    scale = 1;
    dragging = false;
    lastMouseX = null,
    lastMouseY = null,
    dragged = 0;
    lasttime = 1577874127;
    timelimit = 0;
    rgblist = ['000000', 'FFFFFF', 'AAAAAA', '555555', 'FED3C7', 'FFC4CE', 'FAAC8E', 'FF8B83', 'F44336', 'E91E63', 'E2669E', '9C27B0', '673AB7', '3F51B5', '004670', '057197', '2196F3', '00BCD4', '3BE5DB', '97FDDC', '167300', '37A93C', '89E642', 'D7FF07', 'FFF6D1', 'F8CB8C', 'FFEB3B', 'FFC107', 'FF9800', 'FF5722', 'B83F27', '795548'];
    nowintevel = 0;

    function update(y, x, color) {
        if (dragged) {
            dragged = 0;
            return;
        }

        let r = parseInt(color.substr(0, 2), 16);
        let g = parseInt(color.substr(2, 2), 16);
        let b = parseInt(color.substr(4, 2), 16);

        ctx.fillStyle = "rgb(" + r + ", " + g + ", " + b + ")";
        ctx.fillRect(x, y, 1, 1);
    }

    function initpale() {
        $('#palette').html('');
        rgblist.forEach(function (item) {
            let newdiv = $('<div class="paleitem" data-cid=' + item + '></div>');
            newdiv.css('background', '#' + item);
            $('#palette').append(newdiv);
        });
        zoom(1)
    }

    binditem = function () {
        $('.paleitem').removeClass("selected");
        $('#custom-color-box').removeClass("selected");
        $(this).addClass("selected");
        nowcolor = $(this).attr('data-cid');
        console.log(nowcolor);
    }

    $('#custom-color-box').bind("click", bindCustomColor);
    $('#custom-color').bind("input", bindCustomColor);
    

    function bindCustomColor(e) {
        $('.paleitem').removeClass("selected");
        $('#custom-color-box').addClass("selected");
        if(e.originalEvent.target.value) {
            CustomColor = e.originalEvent.target.value.substr(1);
        }
        nowcolor = CustomColor;
        console.log(nowcolor);
    }

    zoom = function (s) {
        scale = s;
        $('#mycanvas').width(800 * scale)
        $('#mycanvas').height(400 * scale)
        if (s == 1) {
            $('#mycanvas').css('top', 0);
            $('#mycanvas').css('left', 0);
        }
    }
    $("[zoom]").click(function () {
        zoom($(this).attr('zoom'));
    });
    initpale();
    $('.paleitem').bind("click", binditem);
    $('[data-cid=0]').addClass("selected");
    $('#mycanvas').bind("click", function () {
        if (new Date() < (lasttime + timelimit) * 1000) {
            alert("冷却时间未到，暂时不能涂色");
            return;
        }
        var x = parseInt(event.offsetX / scale);
        var y = parseInt(event.offsetY / scale);
        update(y, x, nowcolor);

        $.post("/paintBoard/paint", JSON.stringify({
            x: x,
            y: y,
            color: nowcolor
        }), function(resp) {
            if (resp.status !== 200) {
                alert(resp.data)
            } else {
                lasttime = (new Date()) / 1000;
                getCountDown(lasttime + timelimit);
            }
        });
    })

    mycanvas = $('#mycanvas');
    mycanvas.bind("mousedown",function(e){
        if(e.button == 2){
            deltaX = e.clientX - mycanvas.position().left;
            deltaY = e.clientY - mycanvas.position().top;
            $(document).bind("mousemove",move);
            $(document).bind("mouseup",stop);
            mycanvas.css("cursor", "move");
        }
        return false;
    })
    
    function move(e){
        let left = e.clientX - deltaX;
        let top = e.clientY - deltaY;
        left=Math.min(left, 0);
        left=Math.max(left, 800-mycanvas.width());
        top=Math.min(top, 0);
        top=Math.max(top, 400-mycanvas.height());
        mycanvas.css({
            "left":left+'px',
            "top":top+'px'
        });
        return false;
    }

    function stop(){
        if(event.button == 2){
            $(document).unbind("mousemove",move);
            $(document).unbind("mouseup",stop);
            mycanvas.css("cursor", "auto");
        }
        return false;
    }

    $('#mycanvas').contextmenu(function(e){
        e.preventDefault();
    })

    $('#mycanvas').bind("wheel", function (event, deltay) {
        let delta = event.originalEvent.deltaY;
        if (delta == 0) return false;
        let y = parseInt(event.offsetY / scale);
        let x = parseInt(event.offsetX / scale);
        let relocate = false;
        if (delta > 0) {
            if (scale == 10) {
                zoom(5);
                relocate = true;
            }
            else if (scale == 5) {
                zoom(1);
            }
        } else {
            if (scale == 1) {
                zoom(5);
                relocate = true;
            }
            else if (scale == 5) {
                zoom(10);
                relocate = true;
            }
        }
        if (relocate) {
            let left = -x * scale + x;
            let top = -y * scale + y;
            left=Math.min(left, 0);
            left=Math.max(left, 800 - mycanvas.width());
            top=Math.min(top, 0);
            top=Math.max(top, 400 - mycanvas.height());
            $('#mycanvas').css('top', top);
            $('#mycanvas').css('left', left);
        }
        return false;
    });

    function getCountDown(timestamp) {
        clearInterval(nowintevel);
        nowintevel = setInterval(function () {
            var nowTime = new Date();
            var endTime = new Date(timestamp * 1000);
            var t = endTime.getTime() - nowTime.getTime();
            if (t < 0) {
                $("#timeleft").html("冷却时间到");
                clearInterval(nowintevel);
                return;
            }
            var hour = Math.floor(t / 1000 / 60 / 60 % 24);
            var min = Math.floor(t / 1000 / 60 % 60);
            var sec = Math.floor(t / 1000 % 60);
            if (hour < 10)
                hour = "0" + hour;
            if (min < 10)
                min = "0" + min;
            if (sec < 10)
                sec = "0" + sec;
            var countDownTime = hour + ":" + min + ":" + sec;
            $("#timeleft").html(countDownTime);
        }, 1000);
    }

    getCountDown(lasttime + timelimit);

    function initialPaint() {
        $.get("/paintBoard/board", function(resp) {
            resp.split('\n').map(function(colorStr, x) {
                colorStr.split("|").map(function(color, y) {
                    //if(color !== '2') console.log(x, y, color);
                    update(y, x, color);
                });
            });
        });
    }

    var ws = null;
    function connectWs() {
        try {
            ws = new WebSocket('${wsurl}/paintBoard/ws');
        } catch (e) {
            //alert("无法连接追踪服务器");
            return;
        }

        ws.onopen = function() {
            var message = {
                "type": "join_channel",
                "channel": "paintboard",
                "channel_param": ""
            };
            ws.send(JSON.stringify(message));
        };

        ws.onmessage = function (event) {
            var data = JSON.parse(event.data);
            if(data.type === "paintboard_update") {
                update(data.y, data.x, data.color);
            } else {
                initialPaint()
            }
        };
    }
    connectWs();
</script>


</body>
</html>
